stages:
  - build
  - package
  - smoke_test
  - deploy

variables:
  HARBOR_URL: "harbor.treok.eu"
  PROJECT: "devops_compcs140"
  #TAG: "$CI_COMMIT_REF_NAME"
  TAG: "temporyTag"
  ACTIVE_BACKEND: "blue"
  DOCKER_HOST: "tcp://docker:2375"
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  DOCKER_CERT_PATH: ""

before_script:
  # Login to Harbor before any stage
  - echo "$HARBOR_PASSWORD" | docker login $HARBOR_URL -u "$HARBOR_USERNAME" --password-stdin

# ====================
# Build Stage
# ====================
build:
  stage: build
  image: docker:26
  services:
    - docker:26-dind
  script:
    - until docker info; do echo "Waiting for Docker daemon..."; sleep 1; done
    - docker build -t $HARBOR_URL/$PROJECT/compse140-test-storage:$TAG ./storage
    - docker build -t $HARBOR_URL/$PROJECT/compse140-test-service1:$TAG ./service1
    - docker build -t $HARBOR_URL/$PROJECT/compse140-test-management:$TAG ./management
    - docker build -t $HARBOR_URL/$PROJECT/compse140-test-monitoring:$TAG ./monitoring
    - docker build -t $HARBOR_URL/$PROJECT/compse140-test-gateway:$TAG ./gateway
  after_script:
    - echo "Cleaning up Docker images after build..."
    - docker system prune -f

# # ====================
# # Package Stage
# # ====================
# package:
#   stage: package
#   image: docker:26
#   services:
#     - docker:26-dind
#   script:
#     - docker push $HARBOR_URL/$PROJECT/compse140-test-storage:$TAG
#     - docker push $HARBOR_URL/$PROJECT/compse140-test-service1:$TAG
#     - docker push $HARBOR_URL/$PROJECT/compse140-test-management:$TAG
#     - docker push $HARBOR_URL/$PROJECT/compse140-test-monitoring:$TAG
#     - docker push $HARBOR_URL/$PROJECT/compse140-test-gateway:$TAG
#   after_script:
#     - echo "Cleaning up Docker images after package..."
#     - docker system prune -f

# # ====================
# # Smoke Test Stage
# # ====================
# smoke_test:
#   stage: smoke_test
#   image: docker:26
#   services:
#     - docker:26-dind
#   script:
#     - echo "Starting smoke test..."
#     # Pull images from Harbor
#     - docker pull $HARBOR_URL/$PROJECT/compse140-test-storage:$TAG
#     - docker pull $HARBOR_URL/$PROJECT/compse140-test-service1:$TAG
#     - docker pull $HARBOR_URL/$PROJECT/compse140-test-management:$TAG
#     - docker pull $HARBOR_URL/$PROJECT/compse140-test-monitoring:$TAG
#     - docker pull $HARBOR_URL/$PROJECT/compse140-test-gateway:$TAG
#     # Start containers temporarily
#     - docker network create smoke_net || true
#     - docker run -d --name storage_test --network smoke_net $HARBOR_URL/$PROJECT/compse140-test-storage:$TAG
#     - docker run -d --name service1_test --network smoke_net $HARBOR_URL/$PROJECT/compse140-test-service1:$TAG
#     - docker run -d --name management_test --network smoke_net $HARBOR_URL/$PROJECT/compse140-test-management:$TAG
#     - sleep 5
#     - echo "Smoke test completed. Containers started successfully."
#   after_script:
#     - echo "Cleaning up Docker images and containers after smoke test..."
#     - docker rm -f storage_test service1_test management_test || true
#     - docker system prune -f

# ====================
# Deploy Stage
# ====================
deploy:
  stage: deploy
  image: alpine:3.18
  variables:
    # Ensure your GitLab runner has bash available
    SHELL: /bin/sh
  before_script:
    # Create .ssh directory
    - mkdir -p ~/.ssh
    # Decode the SSH key from the GitLab variable
    - echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa
    # Set correct permissions
    - chmod 600 ~/.ssh/id_rsa
    # Start ssh-agent and add the key 
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/id_rsa

  script:
    # Connect to the VM and run your deployment commands
    - ssh -o StrictHostKeyChecking=no ubuntu@86.50.22.0 "
        echo 'Connected to VM, starting deployment...' &&
        docker login $HARBOR_URL -u $HARBOR_USERNAME -p $HARBOR_PASSWORD &&
        export APP_VERSION=$TAG &&
        export ACTIVE_BACKEND=$ACTIVE_BACKEND &&
        cd ~/project &&
        touch humaFile.txt &&
        echo 'Deployment completed successfully.'
      "


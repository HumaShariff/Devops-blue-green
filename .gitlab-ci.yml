stages:
  - build
  - deploy
  - clean

variables:
  TARGET_IP: "195.148.23.137"
  TARGET_USER: "ubuntu"
  SSH_PRIVATE_KEY_B64: "$SSH_PRIVATE_KEY"

# ------------------- BUILD (optional) -------------------
build:
  stage: build
  tags:
    - csc
  image: docker:latest
  services:
    - docker:dind
  rules:
    - if: '$CI_COMMIT_TAG == "deploy"'
      when: never        # CSC runners cannot run DIND, so disable
  script:
    - echo "Skipping build (DIND unsupported on CSC runners)"

# ------------------- DEPLOY -------------------
deploy:
  stage: deploy
  tags:
    - csc
  image: alpine:latest
  needs: []
  rules:
    - if: '$CI_COMMIT_TAG == "deploy"'
  before_script:
    - apk add --no-cache openssh-client python3 py3-pip rsync ansible bash curl
    - mkdir -p /root/.ssh
    - printf '%s' "$SSH_PRIVATE_KEY_B64" | base64 -d > /root/.ssh/key.pem
    - chmod 600 /root/.ssh/key.pem
    - echo -e "Host *\n\tStrictHostKeyChecking no\n" > /root/.ssh/config
  script:
    - echo "[target]" > inventory.ini
    - echo "$TARGET_IP ansible_user=$TARGET_USER ansible_ssh_private_key_file=/root/.ssh/key.pem" >> inventory.ini
    - ansible-playbook -i inventory.ini deploy.yml

# ------------------- CLEAN -------------------
clean:
  stage: clean
  tags:
    - csc
  image: alpine:latest
  rules:
    - if: '$CI_COMMIT_TAG == "clean"'
  before_script:
    - apk add --no-cache openssh-client python3 py3-pip rsync ansible bash curl
    - mkdir -p /root/.ssh
    - printf '%s' "$SSH_PRIVATE_KEY_B64" | base64 -d > /root/.ssh/key.pem
    - chmod 600 /root/.ssh/key.pem
    - echo -e "Host *\n\tStrictHostKeyChecking no\n" > /root/.ssh/config
  script:
    - echo "[target]" > inventory.ini
    - echo "$TARGET_IP ansible_user=$TARGET_USER ansible_ssh_private_key_file=/root/.ssh/key.pem" >> inventory.ini
    - ansible-playbook -i inventory.ini clean.yml

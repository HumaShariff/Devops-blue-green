stages:
  - build
  - test
  - package
  - smoketest
  - scan
  - deliver

variables:
  DOCKER_HOST: "tcp://docker:2375"
  DOCKER_TLS_CERTDIR: ""

# Use Docker-in-Docker service
services:
  - name: docker:dind
    alias: docker

# Build stage: compile Java
build:
  stage: build
  image: eclipse-temurin:21-jre-alpine
  script:
    - javac -d build src/AverageServer.java
  artifacts:
    paths:
      - build/

# Test stage: simple smoke test
test:
  stage: test
  image: curlimages/curl:8.3.0
  script:
    - chmod +x tests/test_smoke.sh
    - ./tests/test_smoke.sh

# Package stage: build Docker image
package:
  stage: package
  image: docker:26
  script:
    - docker build -t average-app -f docker/Dockerfile .
  artifacts:
    paths:
      - trivy-report.json
  only:
    - branches

# Smoketest stage: verify container runs
smoketest:
  stage: smoketest
  image: docker:26
  script:
    - docker run -d -p 8199:8199 --name test-container average-app
    - sleep 5
    - curl -X POST -H "Content-Type:application/json" -H "Accept:text/plain" -d '{"numbers":[1,2,3]}' http://localhost:8199
    - docker stop test-container
    - docker rm test-container

# Scan stage: Trivy vulnerability scan
scan:
  stage: scan
  image: aquasec/trivy:0.67.1
  script:
    - trivy image --severity HIGH,CRITICAL -f json -o trivy-report.json average-app:latest
    - cat trivy-report.json
  allow_failure: false

# Deliver stage: push to Harbor (only on branch 'deliver')
deliver:
  stage: deliver
  image: docker:26
  script:
    - echo "$HARBOR_PASSWORD" | docker login harbor.treok.eu -u "$HARBOR_USERNAME" --password-stdin
    - docker tag average-app harbor.treok.eu/devops_compcs140/compse140-test-service1:latest
    - docker push harbor.treok.eu/devops_compcs140/compse140-test-service1:latest
  only:
    - deliver


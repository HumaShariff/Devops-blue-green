stages:
  - build
  - test
  - package
  - smoketest
  - scan
  - deliver

#variables:
#  DOCKER_HOST: "unix:///var/run/docker.sock"

variables:
  DOCKER_HOST: "tcp://docker:2375"
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  DOCKER_CERT_PATH: ""

# 1️⃣ Build Stage
build:
  stage: build
  image: amazoncorretto:21-alpine
  script:
    - "javac src/AverageServer.java -d build"
  artifacts:
    paths:
      - build/
    expire_in: 1h

# 2️⃣ Test Stage
test:
  stage: test
  image: amazoncorretto:21-alpine
  needs: ["build"]
  script:
    - "apk add --no-cache curl"
    - "java -cp build AverageServer &"
    - "sleep 3"
    - "response=$(curl -s -X POST http://localhost:8199 -H 'Content-Type: application/json' -d '{\"numbers\":[1,3,7,8]}')"
    - "if [ \"$response\" = \"4\" ]; then echo 'Test passed'; else echo 'Test failed: $response'; exit 1; fi"

# 3️⃣ Package Stage
package:
  stage: package
  image: docker:26
  services:
    - docker:dind
  needs: ["build"]
  script:
    #- "docker build -t average-app ."
    - docker build -t harbor.treok.eu/devops_compcs140/compse140-test-service1:latest .
    - docker push harbor.treok.eu/devops_compcs140/compse140-test-service1:latest

# 4️⃣ Smoketest Stage
smoketest:
  stage: smoketest
  image: docker:26
  services:
    - docker:dind
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
  needs: ["package"]
  script:
    - "apk add --no-cache curl"     # ✅ install curl (Alpine package manager)
    - "docker build -t average-app ."
    - "docker run -d -p 8199:8199 --name average-test average-app"
    - "sleep 5"
    - "response=$(curl -s -X POST http://docker:8199 -H 'Content-Type: application/json' -d '{\"numbers\":[2,4,6]}')"
    - "echo Response: $response"
    - "docker stop average-test"
    - "docker rm average-test"
    - "if [ \"$response\" != \"4\" ]; then exit 1; fi"

# 5️⃣ Scan Stage
scan:
  stage: scan
  image: docker:26
  services:
    - docker:26-dind
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
  needs: ["package"]
  script:
    - docker pull harbor.treok.eu/devops_compcs140/compse140-test-service1:latest
    - docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:0.67.1 image --skip-version-check --severity HIGH,CRITICAL -f json -o trivy-report.json harbor.treok.eu/devops_compcs140/compse140-test-service1:latest
  #script:
   # - docker images
   # # Run Trivy scan on the built image
   # - docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:0.67.1 image --severity HIGH,CRITICAL -f json -o trivy-report.json average-app:latest
   # - cat trivy-report.json
  allow_failure: false


# 6️⃣ Deliver Stage
deliver:
  stage: deliver
  image: docker:26
  services:
    - docker:dind
  needs: ["scan"]
# rules:
 #   - if: '$CI_COMMIT_BRANCH == \"deliver\"'
  script:
    - "echo $HARBOR_PASSWORD | docker login harbor.treok.eu -u $HARBOR_USERNAME --password-stdin"
    - "docker tag average-app:latest harbor.treok.eu/$HARBOR_USERNAME/average-app:latest"
    - "docker push harbor.treok.eu/$HARBOR_USERNAME/average-app:latest"


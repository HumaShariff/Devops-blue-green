stages:
  - build
  - package
  - deploy

variables:
  HARBOR_URL: "harbor.treok.eu"         # Your real Harbor registry
  PROJECT: "devops_compcs140"
  TAG: "$CI_COMMIT_REF_NAME"
  ACTIVE_BACKEND: "blue"               # blue receives traffic first

  DOCKER_HOST: "tcp://docker:2375"
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2

# -------- Common before_script --------
before_script:
  - echo "$HARBOR_PASSWORD" | docker login $HARBOR_URL -u "$HARBOR_USERNAME" --password-stdin

# -------- BUILD --------
build:
  stage: build
  tags:
    - docker
  image:
    name: docker:24
    entrypoint: ["/usr/bin/env", "bash", "-c"]
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
  script:
    - echo "‚è≥ Waiting for Docker daemon..."
    - until docker info; do echo "daemon not ready..."; sleep 1; done

    # Build all services based on your folder structure
    - docker build -t $HARBOR_URL/$PROJECT/compse140-test-storage:$TAG ./storage
    - docker build -t $HARBOR_URL/$PROJECT/compse140-test-service1:$TAG ./service1
    - docker build -t $HARBOR_URL/$PROJECT/compse140-test-management:$TAG ./management
    - docker build -t $HARBOR_URL/$PROJECT/compse140-test-monitoring:$TAG ./monitoring
    - docker build -t $HARBOR_URL/$PROJECT/compse140-test-gateway:$TAG ./gateway

  after_script:
    - echo "‚úÖ Build stage finished at $(date)"
    - docker images

# -------- PACKAGE (push) --------
package:
  stage: package
  tags:
    - docker
  script:
    - docker push $HARBOR_URL/$PROJECT/compse140-test-storage:$TAG
    - docker push $HARBOR_URL/$PROJECT/compse140-test-service1:$TAG
    - docker push $HARBOR_URL/$PROJECT/compse140-test-management:$TAG
    - docker push $HARBOR_URL/$PROJECT/compse140-test-monitoring:$TAG
    - docker push $HARBOR_URL/$PROJECT/compse140-test-gateway:$TAG

  after_script:
    - echo "‚úÖ Package stage completed. All images pushed to Harbor."

# -------- DEPLOY --------
deploy:
  stage: deploy
  tags:
    - docker
  script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa

    - |
      ssh -o StrictHostKeyChecking=no ubuntu@$SERVER_IP "
        echo 'üîê Logged in. Starting deploy...'
        docker login $HARBOR_URL -u $HARBOR_USERNAME -p $HARBOR_PASSWORD &&
        export APP_VERSION=$TAG &&
        export ACTIVE_BACKEND=$ACTIVE_BACKEND &&
        cd ~/project &&
        docker-compose pull &&
        docker-compose up -d
      "

  after_script:
    - echo "‚úÖ Deploy stage completed at $(date)"
